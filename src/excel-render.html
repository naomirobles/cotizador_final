<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccionar Celda de Excel</title>
    <link href="./output.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-2 h-screen overflow-hidden">
    <div class="h-screen flex flex-col">
        <!-- Header con información - compacto -->
        <div class="flex-shrink-0 mb-3 bg-white p-3 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold text-gray-800 mb-1">
                Hoja: <span id="sheetName" class="text-blue-600">-</span>
            </h2>
            <p class="text-sm text-gray-600">
                Haz clic en cualquier celda para seleccionarla e importar su valor.
            </p>
        </div>

        <!-- Tabla - ocupa todo el espacio disponible -->
        <div class="flex-1 bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="h-full overflow-auto">
                <table class="w-full h-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr id="tableHeader">
                            <!-- Los headers se generarán dinámicamente -->
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se generarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mensaje de carga - posicionado absolutamente -->
        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Cargando datos...</p>
            </div>
        </div>

        <!-- Mensaje si no hay datos - posicionado absolutamente -->
        <div id="noData" class="absolute inset-0 flex items-center justify-center bg-white hidden">
            <div class="text-center">
                <div class="text-gray-400 mb-4">
                    <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <p class="text-gray-500 text-lg">No hay datos para mostrar en esta hoja.</p>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        console.log('Script excel-render.html cargado');

        // Función para generar la tabla
        function generateTable(data, sheetName) {
            console.log('Generando tabla con datos:', data ? data.length : 0, 'filas, hoja:', sheetName);
            
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const loadingDiv = document.getElementById('loading');
            const noDataDiv = document.getElementById('noData');
            const sheetNameSpan = document.getElementById('sheetName');
            
            // Actualizar nombre de hoja
            sheetNameSpan.textContent = sheetName || 'Sin nombre';
            
            // Limpiar contenido previo
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            loadingDiv.style.display = 'none';

            if (!data || data.length === 0) {
                noDataDiv.classList.remove('hidden');
                return;
            }

            noDataDiv.classList.add('hidden');

            // Calcular el número máximo de columnas
            const maxColumns = Math.max(...data.map(row => Array.isArray(row) ? row.length : 0));

            if (maxColumns === 0) {
                noDataDiv.classList.remove('hidden');
                return;
            }

            // Generar headers numerados (Col A, Col B, etc. como Excel)
            for (let i = 0; i < maxColumns; i++) {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 last:border-r-0 bg-gray-50 sticky top-0';
                th.textContent = getExcelColumnName(i);
                tableHeader.appendChild(th);
            }

            console.log('Headers generados:', maxColumns, 'columnas');

            // Generar filas de datos
            data.forEach((rowData, rowIndex) => {
                if (!Array.isArray(rowData)) return;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';

                // Crear celdas para cada columna
                for (let colIndex = 0; colIndex < maxColumns; colIndex++) {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 text-sm text-gray-900 cursor-pointer hover:bg-blue-100 transition-colors duration-150 border-r border-gray-100 last:border-r-0 max-w-xs truncate';
                    
                    const cellData = rowData[colIndex] !== undefined && rowData[colIndex] !== null ? String(rowData[colIndex]) : '';
                    td.textContent = cellData;
                    td.title = cellData; // Tooltip para texto largo
                    
                    // Solo agregar evento de clic si la celda no está vacía
                    if (cellData.trim() !== '') {
                        td.addEventListener('click', (e) => selectCell(cellData, rowIndex, colIndex, e));
                        td.classList.add('hover:bg-blue-100');
                    } else {
                        td.className += ' bg-gray-50 cursor-default hover:bg-gray-50';
                    }
                    
                    row.appendChild(td);
                }

                tableBody.appendChild(row);
            });

            console.log('Tabla generada con', data.length, 'filas');
        }

        // Función para convertir índice de columna a nombre de Excel (A, B, C, ..., AA, AB, etc.)
        function getExcelColumnName(index) {
            let result = '';
            while (index >= 0) {
                result = String.fromCharCode(65 + (index % 26)) + result;
                index = Math.floor(index / 26) - 1;
            }
            return result;
        }

        // Función para manejar la selección de celda
        function selectCell(value, row, col, event) {
            console.log('Celda seleccionada:', value, 'en posición', row, col);
            
            // Crear objeto con información de la celda seleccionada
            const cellData = {
                value: value,
                row: row + 1, // +1 para que sea 1-indexed como Excel
                column: col + 1, // +1 para que sea 1-indexed
                columnLetter: getExcelColumnName(col),
                address: `${getExcelColumnName(col)}${row + 1}` // Ej: A1, B2, etc.
            };

            // Efecto visual
            const allCells = document.querySelectorAll('td');
            allCells.forEach(cell => {
                cell.classList.remove('bg-green-200', 'bg-blue-200');
            });
            
            if (event && event.target) {
                event.target.classList.add('bg-green-200');
                event.target.classList.remove('hover:bg-blue-100');
            }

            // Enviar al proceso principal
            if (window.api && window.api.sendSelectedCell) {
                console.log('Enviando celda seleccionada al proceso principal');
                window.api.sendSelectedCell(cellData);
            } else {
                console.error('API no disponible para enviar celda seleccionada');
            }
        }

        // Escuchar datos del proceso principal
        if (window.api && window.api.onLoadSheetData) {
            console.log('Configurando listener para datos de hoja');
            window.api.onLoadSheetData((data) => {
                console.log('Datos recibidos del proceso principal:', data);
                currentData = data.data;
                generateTable(currentData, data.sheetName);
            });
        } else {
            console.error('API no disponible');
            // Mostrar mensaje de error
            document.getElementById('loading').innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <p>Error: API no disponible</p>
                    <p class="text-sm">La comunicación con Electron no está funcionando</p>
                </div>
            `;
        }

        // Log para debug
        console.log('window.api disponible:', !!window.api);
        if (window.api) {
            console.log('Métodos disponibles:', Object.keys(window.api));
        }
    </script>
</body>
</html>